# ---------- Populate modules from local repo ----------
# Usage: ai --populate
if [[ "${1:-}" == "--populate" ]]; then
  log "Populating modules into DB from local repository..."
  # Define local repo path
  REPO_DIR="${HOME}/_NIX-SYSOP-AI-AGENT-by-Aris-Arjuna-Noorsanto"
  # Simple HMAC secret for module verification (store securely)
  HMAC_SECRET="${AI_HMAC_SECRET:-supersecretkey}"

  for f in "$REPO_DIR"/modules/*.sh; do
    [[ -f "$f" ]] || continue
    name=$(basename "$f" .sh)
    code=$(cat "$f")
    # Compute HMAC for integrity
    hmac=$(python3 -c "import hmac, hashlib; print(hmac.new(b'$HMAC_SECRET', b'''$code''', hashlib.sha256).hexdigest())")
    log "Inserting module '$name' with HMAC $hmac"
    python3 - <<PY
import sqlite3, os
db = os.path.expanduser("$DB")
conn = sqlite3.connect(db)
cur = conn.cursor()
# Insert code as BLOB + store HMAC
cur.execute("INSERT OR REPLACE INTO modules(name, code, last_update) VALUES(?,?,datetime('now'))",
            (sys.argv[1], sys.argv[2].encode('utf-8')))
conn.commit()
conn.close()
PY
    done

  log "âœ… Module population complete."
  exit 0
fi