#!/usr/bin/env bash
# ai_launch.sh - Bootstrap + Self-Healing + Launch AI CLI with logging

set -euo pipefail
AI_HOME="$HOME/.local_ai"
BIN_DIR="$HOME/.bin"
AI_CLI="$BIN_DIR/ai"
REPO_DIR="$HOME/_NIX-SYSOP-AI-AGENT-by-Aris-Arjuna-Noorsanto"
LOG_DIR="$AI_HOME/logs"
LOG_FILE="$LOG_DIR/ai_boot.log"

mkdir -p "$LOG_DIR"

log() {
    local timestamp
    timestamp="$(date '+%Y-%m-%d %H:%M:%S')"
    echo -e "[$timestamp] $*" | tee -a "$LOG_FILE"
}

# ---- Dependencies ----
install_with_apt() {
    sudo apt-get update -y
    sudo apt-get install -y python3-full sqlite3 curl wget git build-essential \
        bash nodejs npm
}

install_with_brew() {
    command -v brew >/dev/null 2>&1 && brew install python sqlite curl wget git node
}

install_with_pip() {
    pip install --upgrade pip
    pip install requests rich
}

bootstrap_deps() {
    log "Checking mandatory dependencies..."
    command -v python3 >/dev/null 2>&1 || install_with_apt
    command -v sqlite3 >/dev/null 2>&1 || install_with_apt
    command -v curl >/dev/null 2>&1 || install_with_apt
    command -v wget >/dev/null 2>&1 || install_with_apt
    command -v node >/dev/null 2>&1 || install_with_apt
}

# ---- Self-Healing CLI ----
prepare_ai_cli() {
    mkdir -p "$AI_HOME" "$BIN_DIR"
    if [ ! -f "$AI_CLI" ]; then
        log "Copying AI CLI from repo..."
        cp "$REPO_DIR/ai" "$AI_CLI"
        chmod +x "$AI_CLI"
        log "‚úÖ AI CLI installed"
    else
        if [ "$REPO_DIR/ai" -nt "$AI_CLI" ]; then
            log "Updating AI CLI from repo..."
            cp "$REPO_DIR/ai" "$AI_CLI"
            chmod +x "$AI_CLI"
            log "‚úÖ AI CLI updated"
        fi
    fi
}

# ---- Self-Healing Modules ----
update_modules() {
    mkdir -p "$AI_HOME/modules"
    for mod in blockchain nostr lightning termux proot url-parser snippet-assembler; do
        repo_mod="$REPO_DIR/modules/$mod.sh"
        local_mod="$AI_HOME/modules/$mod.sh"
        if [ ! -f "$local_mod" ] || [ "$repo_mod" -nt "$local_mod" ]; then
            log "Updating module $mod..."
            cp "$repo_mod" "$local_mod"
            chmod +x "$local_mod"
            log "‚úÖ Module $mod updated"
        fi
    done
}

# ---- Launch CLI ----
launch_ai() {
    if [ $# -eq 0 ]; then
        log "Usage: ai_launch.sh 'your prompt'"
        exit 1
    fi
    log "Launching AI CLI with prompt: $*"
    "$AI_CLI" "$@"
    log "AI CLI finished execution"
}

main() {
    log "üîç Bootstrapping AI environment..."
    bootstrap_deps
    install_with_brew || true
    install_with_pip || true
    prepare_ai_cli
    update_modules
    launch_ai "$@"
}

main "$@"