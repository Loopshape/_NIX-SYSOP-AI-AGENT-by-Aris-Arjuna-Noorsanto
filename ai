#!/usr/bin/env bash
# ~/.bin/ai — Multi-code block syntax highlighting + English/German/Chinese handling

set -euo pipefail
IFS=$'\n\t'

AI_HOME="$HOME/.local_ai"
DB="$AI_HOME/core.db"
PYTHON_BIN="python3"

mkdir -p "$AI_HOME"

# --- Initialize SQLite DB ---
init_db() {
    sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS mindflow(
        id INTEGER PRIMARY KEY,
        session_id TEXT,
        loop_id INTEGER,
        model_name TEXT,
        output TEXT,
        rank INTEGER,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
    );"
    sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS task_logs(
        id INTEGER PRIMARY KEY,
        tool_used TEXT,
        args TEXT,
        output_summary TEXT,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
    );"
    sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS cache(
        prompt_hash TEXT PRIMARY KEY,
        final_answer TEXT
    );"
}

# --- Python snippet for multi-block syntax highlighting ---
highlight_output() {
    local text="$1"
    "$PYTHON_BIN" - <<EOF
import sys
from rich.console import Console
from rich.syntax import Syntax
import re

console = Console()
blocks = re.split(r'```([a-zA-Z0-9]*)\n(.*?)```', """$text""", flags=re.DOTALL)

i = 0
while i < len(blocks):
    if i + 2 < len(blocks):
        lang = blocks[i+1] if blocks[i+1] else "text"
        code = blocks[i+2]
        syntax = Syntax(code, lang, theme="monokai", line_numbers=True)
        console.print(syntax)
        i += 3
    else:
        if blocks[i].strip():
            console.print(blocks[i])
        i += 1
EOF
}

# --- Translate Chinese input to English ---
translate_chinese() {
    local prompt="$1"
    "$PYTHON_BIN" - <<PY
from googletrans import Translator
prompt = """$prompt"""
translator = Translator()
if any('\u4e00' <= c <= '\u9fff' for c in prompt):
    translated = translator.translate(prompt, dest='en').text
else:
    translated = prompt
print(translated)
PY
}

# --- Translate English output to German ---
translate_to_german() {
    local text="$1"
    "$PYTHON_BIN" - <<PY
from googletrans import Translator
text = """$text"""
translator = Translator()
translated = translator.translate(text, dest='de').text
print(translated)
PY
}

# --- Detect German in prompt ---
detect_german() {
    local prompt="$1"
    if [[ "$prompt" =~ [äöüßÄÖÜ] ]]; then
        return 0  # German detected
    else
        return 1
    fi
}

# --- AI logic (example placeholders) ---
run_ai() {
    local prompt="$1"
    local response

    # Auto-detect German
    if detect_german "$prompt"; then
        german_mode=1
    else
        german_mode=0
    fi

    # Translate Chinese input to English
    prompt=$(translate_chinese "$prompt")

    # --- Example AI responses ---
    if [[ "$prompt" =~ "capital of Germany" ]]; then
        response="The capital of Germany is Berlin."
    elif [[ "$prompt" =~ "def " ]]; then
        response="```python\ndef greet(name):\n    return f'Hello, {name}!'\n```"
    else
        response="$prompt"
    fi

    # Translate output to German if flagged
    if [[ "$german_mode" -eq 1 ]]; then
        response=$(translate_to_german "$response")
    fi

    # Syntax highlight multi-block
    highlight_output "$response"

    # Log to cache
    local hash
    hash=$(echo -n "$prompt" | sha256sum | awk '{print $1}')
    sqlite3 "$DB" "INSERT OR REPLACE INTO cache(prompt_hash, final_answer) VALUES ('$hash', '$response');"
}

# --- Main ---
if [ $# -lt 1 ]; then
    echo "Usage: ai 'your prompt'"
    exit 1
fi

init_db
run_ai "$*"