#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

AI_HOME="$HOME/.local_ai"
DB="$AI_HOME/core.db"
log(){ echo "[$(date '+%H:%M:%S')] $*"; }

# --- 1. Load environment variables ---
[ -f "$HOME/.env" ] && set -a && source "$HOME/.env" && set +a

# --- 2. First run setup (DB check) ---
if [ ! -f "$DB" ]; then
    log "First run detected â€” installing core dependencies..."
    if command -v apt >/dev/null 2>&1; then
        log "Installing dependencies via apt..."
        sudo apt update -y
        sudo apt install -y python3-full build-essential curl git unzip sqlite3
    fi

    mkdir -p "$AI_HOME/modules"
    sqlite3 "$DB" "CREATE TABLE IF NOT EXISTS mindflow(
        id INTEGER PRIMARY KEY,
        session_id TEXT,
        query TEXT,
        response TEXT,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
    );"
fi

# --- 3. Run prompt ---
if [ $# -eq 0 ]; then
    echo "Usage: ai 'your prompt here'"
    exit 1
fi

PROMPT="$*"
log "Running AI query: $PROMPT"

# --- 4. Execute via Ollama ---
if ! command -v ollama >/dev/null 2>&1; then
    log "Error: Ollama CLI not found. Install Ollama first."
    exit 1
fi

ollama run llama3 "$PROMPT"
