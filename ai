#!/usr/bin/env bash
# ~/.bin/ai â€” Bulletproof Ollama CLI wrapper
set -euo pipefail
IFS=$'\n\t'

AI_HOME="${HOME}/.local_ai"
DB="$AI_HOME/core.db"
MODULES="$AI_HOME/modules"
MODEL="${AI_MODEL:-2244:latest}"

mkdir -p "$AI_HOME" "$MODULES"

log() { echo -e "[\033[1;32m$(date '+%H:%M:%S')\033[0m] $*"; }

# --- Load environment ---
[ -f "$HOME/.env" ] && source "$HOME/.env"
[ -f "$HOME/.env.local" ] && source "$HOME/.env.local"

# --- Ensure Python3 ---
if ! command -v python3 &>/dev/null; then
    log "Installing python3-full..."
    sudo apt update && sudo apt install -y python3-full
fi

# --- Initialize DB if missing ---
if [ ! -f "$DB" ]; then
    log "Initializing AI core database..."
    sqlite3 "$DB" <<SQL
CREATE TABLE IF NOT EXISTS mindflow(
    id INTEGER PRIMARY KEY,
    session_id TEXT,
    loop_id INTEGER,
    model_name TEXT,
    output TEXT,
    rank INTEGER,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE IF NOT EXISTS task_logs(
    id INTEGER PRIMARY KEY,
    tool_used TEXT,
    args TEXT,
    output_summary TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE IF NOT EXISTS cache(
    prompt_hash TEXT PRIMARY KEY,
    final_answer TEXT
);
SQL
fi

# --- Load modules ---
for m in "$MODULES"/*.sh; do
    [ -f "$m" ] && source "$m"
done

# --- Build prompt ---
PROMPT="$*"
if [ -z "$PROMPT" ]; then
    log "Usage: ai 'your question or task'"
    exit 1
fi

# --- Check cache ---
PROMPT_HASH=$(echo -n "$PROMPT" | sha256sum | awk '{print $1}')
CACHED=$(sqlite3 "$DB" "SELECT final_answer FROM cache WHERE prompt_hash='$PROMPT_HASH';")
if [ -n "$CACHED" ]; then
    echo "$CACHED"
    exit 0
fi

# --- Run Ollama ---
OUTPUT=$(ollama run "$MODEL" --prompt "$PROMPT" 2>/dev/null || true)

# --- Auto-translate Chinese to English ---
if echo "$OUTPUT" | grep -P '[\p{Han}]' &>/dev/null; then
    if command -v translate-cli &>/dev/null; then
        OUTPUT=$(translate-cli -t en <<< "$OUTPUT")
    fi
fi

# --- Restrict to English/German output ---
OUTPUT=$(echo "$OUTPUT" | LANG=en_US.UTF-8 perl -pe 's/[\p{^Latin}\p{^Common}]//g')

# --- Store in cache ---
sqlite3 "$DB" "INSERT OR REPLACE INTO cache(prompt_hash, final_answer) VALUES ('$PROMPT_HASH', '$(echo "$OUTPUT" | sqlite3_escape)');"

# --- Print result with optional syntax highlight ---
if command -v pygmentize &>/dev/null && echo "$OUTPUT" | grep -qE '```'; then
    echo "$OUTPUT" | pygmentize -f terminal256 -g
else
    echo "$OUTPUT"
fi

# --- Utility: escape string for SQLite ---
sqlite3_escape() {
    perl -MString::Escape -pe 's/([\'"\\])/\\$1/g'
}